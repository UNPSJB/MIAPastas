{% extends 'base.html' %}
{% load staticfiles %}
{% load bootstrap3 %}
{% load recetas %}
{% block contenido %}

<div class="container">
    <div class="panel panel-default">
        <div class="panel-heading"><p class="text-center login-title"><font face="tahoma" size="4" color="black"><b>Rendicion Hoja de Ruta {{hoja.fecha_creacion}}</b></font></p></div>
            <div class="panel-body">                
                <form class=" form-horizontal" method = "post" onsubmit = "return validar()">    
                    {% csrf_token %}
                    {{ cobros_factory.management_form }}
                        {% for f in cobros_factory %}
                            {% bootstrap_form_errors f %}
                        {% endfor %}
                <h1><font color="#2E8B57" font-size="20%">Se Registraron correctamente las entregas.</font> </h1>
                    {% for e in hoja.entrega_set.all%}
                            <p>&nbsp;</p>
                            <div>
                                <span style="text-decoration: underline;font-size: 150%; ">
                                    <strong>
                                        Cliente: {{e.pedido.cliente.razon_social}} {{e.pedido.get_tipo_pedido_display}}
                                    </strong>
                                </span>
                            </div>
                            <p>&nbsp;</p>
                           <div class="bordeado item-page" style=" border-spacing:0 0px;line-height: 10%;border-style: solid;   border-color: white red; ">                            
                            {% for d in e.entregadetalle_set.all %}
                                <p>&nbsp;</p>
                                <div style="margin-left: 10%;">
                                <span style="text-decoration: underline; ">
                                    <strong>
                                        <font color="blue">Producto: {{d.get_producto_terminado.nombre}}</font>
                                    </strong>
                                </span>
                                </div>
                                <p>&nbsp;</p>
                                <p>&nbsp;</p>
                                <div class=" form-group" style="margin-left: 3%;">
                                    <label class="col-sm-2 control-label">Cantidad Pedida</label>
                                    <div class="col-sm-10" style="padding:0.7%;">
                                          {% devolver_cantidad_pedida d %}
                                    </div>
                                </div>                                
                                <div class=" form-group" style="margin-left: 3%;">
                                    <label class="col-sm-2 control-label">Cantidad Entregada</label>
                                    <div class="col-sm-10" style="padding:0.7%;">
                                        {{d.cantidad_entregada}}
                                    </div>
                                </div>

                                <div class=" form-group" style="margin-left: 3%;">
                                    <label class="col-sm-2 control-label">Precio Total</label>
                                    <div class="col-sm-10" style="padding:0.7%;">
                                        {{ d.precio }}
                                    </div>                                
                                </div>                            
                            {% endfor %}
                            {% if e.precio_total > 0 %}                            
                            <div class="form-inline pagos" style="margin-left: 3%;">                            
                                <h1 style="margin-left: 5%;"><font color="black" size="5%">Pagos </font> </h1>
                                <label for="monto"> Monto a abonar: $ </label>
                                <input type="text" class="form-control monto" id="monto"
                                        data-preciototal= "{%devolver_precio_total e%}"
                                        data-entregaid = "{{ e.id }}"
                                         >                                
                                <label for="nro_doc"> Nro factura/remito:  </label>
                                <input type="text" class="form-control documento" id="nro-{{ e.id }}" >                                

                                <button type="button" id="pagar" onclick="" class="boton_bottom btn btn-success pull-down"><span class="glyphicon glyphicon-arrow-right" aria-hidden="true">  Pagar  </span></button>
                            </div>
                            {% endif%}
                            </div>

                             
                    {% endfor %}  
                     
                     {% buttons %}
                        <button id = "btn-submit" type="submit" class="btn btn-primary">
                            {% bootstrap_icon "star" %} Registrar Pagos
                        </button>
                    {% endbuttons %}    
                    <div id="hiddens_cobros"></div>             
                </form>

            </div>
        </div>
            <a href="javascript:history.back()" class="btn pull-right" ><font face="tahoma" size="2" color="green"><b><span class="glyphicon glyphicon-triangle-left" aria-hidden="true"> Volver </span></b></font></a>
</div>
</div>
{% endblock %}
{% block javascript %}
<script>
var prefix = "{{prefix_cobros}}";


function armar_inputs(){
    var html = "";
    var a = $(".monto");
    for (i=0;i<_.size(a);i++){
        html = html + armar_hidden(prefix, a[i].value, "cantidad_abonada",i);        
        id_num = "#nro-"+a[i].getAttribute("data-entregaid"); 
        numero_doc = $(id_num).val();
        html = html + armar_hidden(prefix, numero_doc, "nro_doc",i);
        html = html + armar_hidden(prefix, a[i].getAttribute("data-entregaid"), "entrega",i);      
    }
    $("#hiddens_cobros").html(html);
    alert(_.size(a));
    document.getElementById("id_"+prefix+"-TOTAL_FORMS").value = _.size(a);


}


function inputs_validos(m){
    var total = 0;
    var valor = 0;
    var diferencia = 0;
    for(i=0; i<_.size(m);i++){
        total = parseFloat(m[i].getAttribute("data-preciototal"));
        valor = parseFloat(m[i].value);  
        id_entrega = m[i].getAttribute("data-entregaid"); 
        id_num = "#nro-"+id_entrega; 
        numero_doc = $(id_num).val();
        if (valor > total){
            diferencia = valor - total; 
            alert("Se pagaton "+diferencia+" pesos de mas para la entrega con id "+id_entrega);
            return false;
        } 
        if  (esFloatPositivo(valor)== false){
            BootstrapDialog.show({
                    title: "Error",
                    cssClass: 'error-dialog',
                    message: "Debe ser un numero positivo el monto de la entrega con id "+id_entrega,
                    type: BootstrapDialog.TYPE_DANGER,
                    buttons: [{
                            label: 'Aceptar',
                            action: function(dialogRef){
                                dialogRef.close();
                            }
                    }]
            });
            return false;
        }
                if(numero_doc.length == 0){
                     if (valor != 0){
                        alert("Debe ingresar un numero de recibo/factura para la entrega con id "+id_entrega);
                        return false;
                }
               
            }
    }
    
    return true; 
}


function validar(){
    var montos_pagados = $(".monto");    
    if (inputs_validos(montos_pagados)){
        console.log("es todo valido hay q mandar true");
        armar_inputs();
        return true;
    }
    return false;    
}
    


$(".monto").click(function(){
    $(this).val($(this).data()["preciototal"]);
});





</script>
{% endblock %}
